{"version":3,"file":"arbox-schedule.js","sourceRoot":"","sources":["../../src/utils/arbox-schedule.ts"],"names":[],"mappings":"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","sourcesContent":["import {IScheduleItem} from \"../interface/schedule\";\r\nimport * as schedule from 'node-schedule';\r\nimport {Job} from \"node-schedule\";\r\nimport {addHours} from \"date-fns\";\r\nimport {API} from \"../arbox-api/login\";\r\nimport {saveData} from \"./save-file.utis\";\r\nimport {arboxAjax} from \"./fetch\";\r\n\r\nexport class ArboxScheduleService {\r\n\r\n    users: IUserObject = {};\r\n    schedule: IUsersSchedule = {};\r\n    arboxSchedule = new ArboxSchedule();\r\n\r\n    restoreData(data) {\r\n        const _dat = JSON.parse(data);\r\n        this.users = JSON.parse(_dat.users);\r\n        this.schedule = JSON.parse(_dat.schedule);\r\n    }\r\n\r\n    getUser(id) {\r\n        return this.users[id];\r\n    }\r\n\r\n    setUser(user: IUser) {\r\n        this.users[user.userFk] = user\r\n        this.users[user.token] = user\r\n        this.save();\r\n    }\r\n\r\n    removeUser(user: IUser) {\r\n        if (this.users[user.userFk]) {\r\n            delete this.users[user.userFk];\r\n            delete this.users[user.token];\r\n            this.save();\r\n            return true;\r\n        }\r\n        return false;\r\n\r\n    }\r\n\r\n    setUserSchedule(_user: IUser, schedule: IScheduleItem) {\r\n        if (!this.schedule[_user.userFk]) {\r\n            this.schedule[_user.userFk] = []\r\n        }\r\n        if (this.schedule[_user.userFk].find((s) => s.schedule.id === schedule.schedule.id)) {\r\n            return false\r\n        }\r\n        const user = this.users[_user.userFk];\r\n        const fetch = arboxAjax(user.token)()(API.scheduleUser(), {\r\n            scheduleFk: schedule.schedule.id,\r\n            userFk: user.userFk,\r\n            membrshipUserFk: user.membrshipUserFk\r\n        });\r\n\r\n\r\n        this.schedule[_user.userFk].push(schedule);\r\n        this.arboxSchedule.startSchedule(schedule, fetch);\r\n\r\n        return true;\r\n    }\r\n\r\n    removeUserSchedule(userId, scheduleId: number) {\r\n        if (!this.schedule[userId]) return false;\r\n\r\n        const index = this.schedule[userId].findIndex((s) => s.schedule.id === scheduleId);\r\n        if (index > -1) {\r\n            this.arboxSchedule.removeSchedule(this.schedule[userId][index].schedule.id);\r\n            this.schedule[userId] = this.schedule[userId].filter((_, _index) => _index !== index);\r\n\r\n            return true\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    getUserSchedule(userId) {\r\n        return this.schedule[userId];\r\n    }\r\n\r\n    save() {\r\n        saveData(this);\r\n    }\r\n}\r\n\r\nexport class ArboxSchedule {\r\n    private scheduleJob = {} as scheduleJob;\r\n\r\n    startSchedule(scheduleItem: IScheduleItem, fetch: () => Promise<any>) {\r\n        const workoutDateWithTime = `${scheduleItem.schedule.date} ${scheduleItem.schedule.time}`;\r\n        let timeBeforeAllow = addHours(new Date(workoutDateWithTime), -scheduleItem.schedule.enableRegistrationTime)\r\n\r\n        if (+timeBeforeAllow < +new Date() || scheduleItem.schedule.enableRegistrationTime === 0) {\r\n            timeBeforeAllow = new Date()\r\n        }\r\n        const startTime = new Date(+new Date(timeBeforeAllow) - (3 * 10 * 1000)); // 30 seconds before\r\n        const endTime = new Date(+new Date(timeBeforeAllow) + (2 * 60 * 1000)); // 2 min after\r\n\r\n        console.log('workoutDateWithTime', workoutDateWithTime);\r\n        console.log('timeBeforeAllow', timeBeforeAllow);\r\n        console.log('startTime', startTime);\r\n        console.log('endTime', endTime);\r\n\r\n        this.scheduleJob[scheduleItem.schedule.id] = schedule.scheduleJob({\r\n            start: startTime,\r\n            end: endTime,\r\n            rule: '*/10 * * * * *'\r\n        }, async () => {\r\n            console.log('trying to sign in to ', scheduleItem.category, scheduleItem.schedule.id, new Date().toISOString());\r\n            if (fetch) {\r\n                try {\r\n                    const res = await fetch();\r\n                    this.removeSchedule(scheduleItem.schedule.id);\r\n                    console.log('your in the workout!!', scheduleItem.schedule.id)\r\n                } catch (e) {\r\n                    this.removeSchedule(scheduleItem.schedule.id);\r\n                    console.log('shoething went wrong', e)\r\n\r\n                }\r\n            }\r\n\r\n        });\r\n    }\r\n\r\n    removeSchedule(scheduleItemId: number) {\r\n        if (this.scheduleJob[scheduleItemId]) {\r\n            this.scheduleJob[scheduleItemId].cancel();\r\n            return true\r\n        }\r\n        return false;\r\n    }\r\n}\r\n\r\ninterface scheduleJob {\r\n    [workoutID: string]: Job\r\n}\r\n\r\nexport interface IUserObject {\r\n    [userId: string]: IUser\r\n}\r\n\r\nexport class User implements IUser {\r\n    constructor(public userFk: number, public membrshipUserFk: number, public token: string) {\r\n    }\r\n}\r\n\r\nexport interface IUser {\r\n    userFk: number,\r\n    membrshipUserFk: number;\r\n    token: string;\r\n}\r\n\r\nexport interface IUsersSchedule {\r\n    [userId: string]: IScheduleItem[]\r\n}\r\n\r\nexport const fakeScheduleItem = {\r\n    \"category\": \"W.O.D\",\r\n    \"schedule\": {\r\n        \"id\": 4716014,\r\n        \"boxFk\": 59,\r\n        \"workoutId\": 81425,\r\n        \"date\": \"2020-06-25\",\r\n        \"time\": \"07:30:00\",\r\n        \"maxUsers\": 16,\r\n        \"minUsers\": 0,\r\n        \"liveLink\": null,\r\n        \"cancelLimit\": null,\r\n        \"coachFk\": 27721,\r\n        \"boxCategoryFk\": 876,\r\n        \"locationsBoxFk\": 48,\r\n        \"enableRegistrationTime\": 48,\r\n        \"disableCancellationTime\": 0.29999999999999999,\r\n        \"enableLateCancellation\": 0,\r\n        \"seriesFk\": 46308,\r\n        \"status\": \"active\",\r\n        \"transparent\": 0,\r\n        \"endTime\": \"08:30:00\",\r\n        \"cancelledBy\": null\r\n    },\r\n    \"numberOfUsers\": 1,\r\n    \"users\": [\r\n        {\r\n            \"id\": 582466,\r\n            \"firstName\": \"\\u05d3\\u05e0\\u05d9\\u05d0\\u05dc\",\r\n            \"lastName\": \"\\u05d0\\u05e4\\u05e8\\u05ea\\u05d9\",\r\n            \"image\": null\r\n        }\r\n    ],\r\n    \"alreadyMember\": false,\r\n    \"coach\": \"\\u05e0\\u05d9\\u05e7\\u05d9 \\u05e4\\u05d8\\u05dc\",\r\n    \"standbyUser\": false,\r\n    \"membershipUserFkRegister\": null\r\n}"]}